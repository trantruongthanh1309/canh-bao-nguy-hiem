<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Há»‡ Thá»‘ng Cáº£nh BÃ¡o Nguy Hiá»ƒm</title>
    <link rel="stylesheet" href="/static/style.css" />

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  </head>

  <body>
    <div class="container">
      <h1>ğŸš¨ Há»† THá»NG Cáº¢NH BÃO NGUY HIá»‚M ğŸš¨</h1>

      <!-- FORM Cáº¢NH BÃO -->
      <form id="alert-form" method="POST" action="/alert" class="alert-form">
        <input type="hidden" name="lat" id="lat" />
        <input type="hidden" name="lng" id="lng" />
        <button type="submit">Gá»¬I Cáº¢NH BÃO NGAY</button>
      </form>

      <!-- Báº¢N Äá»’ -->
      <div id="map" style="height: 400px; margin: 20px 0"></div>

      <!-- DANH SÃCH -->
      <div class="alert-list">
        <h2>ğŸ“‹ Danh sÃ¡ch cáº£nh bÃ¡o gáº§n Ä‘Ã¢y:</h2>
        <ul></ul>
      </div>
    </div>

    <script>
      // Gá»¬I Vá»Š TRÃ NGAY KHI NHáº¤N NÃšT
      document
        .getElementById("alert-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              function (position) {
                document.getElementById("lat").value = position.coords.latitude;
                document.getElementById("lng").value =
                  position.coords.longitude;
                e.target.submit(); // gá»­i form
              },
              function () {
                alert("KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­. Vui lÃ²ng báº­t Ä‘á»‹nh vá»‹.");
              }
            );
          } else {
            alert("TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ Ä‘á»‹nh vá»‹.");
          }
        });

      // Báº¢N Äá»’
      const map = L.map("map").setView([16.047079, 108.20623], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors",
      }).addTo(map);

      let markers = [];

      function fetchAlerts() {
        fetch("/api/alerts")
          .then((res) => res.json())
          .then((data) => {
            // XÃ³a marker cÅ©
            markers.forEach((marker) => map.removeLayer(marker));
            markers = [];

            // Hiá»ƒn thá»‹ danh sÃ¡ch
            const list = document.querySelector(".alert-list ul");
            list.innerHTML = "";

            data.forEach((alert) => {
              // ThÃªm marker má»›i
              const marker = L.marker([alert.lat, alert.lng])
                .addTo(map)
                .bindPopup(`â° ${alert.time}<br>ğŸ“ ${alert.lat}, ${alert.lng}`);
              markers.push(marker);

              // ThÃªm vÃ o danh sÃ¡ch
              const li = document.createElement("li");
              li.textContent = `â° ${alert.time} â€“ ğŸ“ ${alert.lat}, ${alert.lng}`;
              list.appendChild(li);
            });
          });
      }

      // Gá»i ngay vÃ  má»—i 5s cáº­p nháº­t
      fetchAlerts();
      setInterval(fetchAlerts, 5000);
    </script>
    <script>
      // Kiá»ƒm tra há»— trá»£ trÃ¬nh duyá»‡t
      const Recognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;

      if (Recognition) {
        const recognition = new Recognition();
        recognition.continuous = true;
        recognition.lang = "vi-VN";
        recognition.interimResults = false;

        recognition.onstart = () => {
          console.log("ğŸ¤ Há»‡ thá»‘ng Ä‘ang nghe...");
        };

        recognition.onresult = function (event) {
          const transcript = event.results[
            event.results.length - 1
          ][0].transcript
            .trim()
            .toLowerCase();
          console.log("ğŸ—£ï¸ Báº¡n vá»«a nÃ³i:", transcript);

          if (transcript.includes("alo")) {
            console.log("âœ… PhÃ¡t hiá»‡n 'alo' â€“ gá»­i cáº£nh bÃ¡o");
            sendLocation();
          }
        };

        recognition.onerror = function (e) {
          console.error("âŒ Lá»—i nháº­n diá»‡n:", e.error);
        };

        recognition.start();
      } else {
        alert("âš ï¸ TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ SpeechRecognition.");
      }

      // Gá»­i vá»‹ trÃ­
      function sendLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              const formData = new FormData();
              formData.append("lat", position.coords.latitude);
              formData.append("lng", position.coords.longitude);

              fetch("/alert", {
                method: "POST",
                body: formData,
              }).then(() => {
                alert("ğŸš¨ ÄÃ£ gá»­i cáº£nh bÃ¡o vÃ¬ báº¡n nÃ³i 'alo'");
              });
            },
            function () {
              alert("âš ï¸ KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­.");
            }
          );
        } else {
          alert("âš ï¸ TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ Ä‘á»‹nh vá»‹.");
        }
      }
    </script>
    <script>
      const SpeechRecogClass =
        window.SpeechRecognition || window.webkitSpeechRecognition;

      if (Recognition) {
        const recognition = new Recognition();
        recognition.continuous = true;
        recognition.lang = "vi-VN";
        recognition.interimResults = false;
        recognition.maxAlternatives = 0.1;

        recognition.onstart = () => {
          console.log("ğŸ¤ Há»‡ thá»‘ng Ä‘ang nghe...");
        };

        recognition.onresult = function (event) {
          let transcript = "";
          for (let i = event.resultIndex; i < event.results.length; ++i) {
            transcript += event.results[i][0].transcript + " ";
          }

          transcript = transcript.trim().toLowerCase();
          console.log("ğŸ—£ï¸ Báº¡n nÃ³i:", transcript);

          // Danh sÃ¡ch tá»« khÃ³a: cáº£ tá»« Ä‘Æ¡n vÃ  cá»¥m tá»«
          const keywords = [
            "alo",
            "cá»©u",
            "giÃºp",
            "giÃºp tÃ´i",
            "cá»©u vá»›i",
            "em bá»‹ báº¯t",
            "trá»£ giÃºp",
            "kháº©n cáº¥p",
            "help",
          ];

          // Kiá»ƒm tra náº¿u ná»™i dung chá»©a báº¥t ká»³ tá»« khÃ³a nÃ o
          const matched = keywords.some((keyword) =>
            transcript.includes(keyword)
          );

          if (matched) {
            console.log("âœ… PhÃ¡t hiá»‡n tá»« kháº©n cáº¥p â€“ gá»­i cáº£nh bÃ¡o");
            sendAlertWithAudio();
            recognition.abort(); // dá»«ng táº¡m Ä‘á»ƒ trÃ¡nh láº·p
          }
        };

        recognition.onerror = function (e) {
          console.error("âŒ Lá»—i nháº­n diá»‡n:", e.error);
        };

        recognition.onend = () => {
          console.log("ğŸ” Tá»± khá»Ÿi Ä‘á»™ng láº¡i sau khi káº¿t thÃºc");
          recognition.start(); // tá»± restart sau má»—i láº§n dá»«ng
        };

        recognition.start();
      } else {
        alert("âš ï¸ TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ SpeechRecognition.");
      }

      function sendLocation(message) {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              const formData = new FormData();
              formData.append("lat", position.coords.latitude);
              formData.append("lng", position.coords.longitude);

              fetch("/alert", {
                method: "POST",
                body: formData,
              }).then(() => {
                alert(message);
              });
            },
            function () {
              alert("âš ï¸ KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­.");
            }
          );
        } else {
          alert("âš ï¸ TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ Ä‘á»‹nh vá»‹.");
        }
      }
    </script>
    <script>
      let mediaRecorder;
      let audioChunks = [];

      // Chuáº©n bá»‹ mic ghi Ã¢m ngay tá»« Ä‘áº§u
      navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);

        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          audioChunks = [];

          const formData = new FormData();
          formData.append("audio", audioBlob, "recording.webm");

          // Láº¤Y Vá»Š TRÃ Ä‘á»ƒ gá»­i cÃ¹ng
          navigator.geolocation.getCurrentPosition(
            (position) => {
              formData.append("lat", position.coords.latitude);
              formData.append("lng", position.coords.longitude);

              // Gá»¬I vá» Flask
              fetch("/alert_audio", {
                method: "POST",
                body: formData,
              }).then(() => {
                alert("ğŸš¨ ÄÃ£ gá»­i cáº£nh bÃ¡o + ghi Ã¢m thÃ nh cÃ´ng!");
              });
            },
            function () {
              alert("âš ï¸ KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­.");
            }
          );
        };
      });

      // Gá»i hÃ m nÃ y khi phÃ¡t hiá»‡n tá»« khÃ³a nguy hiá»ƒm
      function sendAlertWithAudio() {
        if (mediaRecorder && mediaRecorder.state !== "recording") {
          audioChunks = [];
          mediaRecorder.start();
          setTimeout(() => mediaRecorder.stop(), 5000); // ghi 3 giÃ¢y
        }
      }
    </script>
  </body>
</html>
